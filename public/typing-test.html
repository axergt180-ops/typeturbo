<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Typemeteor - Typing Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .blob {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.3;
      animation: blob 8s infinite;
    }
    
    @keyframes blob {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(30px, -50px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.9); }
    }
    
    .word {
      display: inline-block;
      margin: 0 6px 0 0;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      white-space: nowrap;
    }
    
    .word-correct {
      color: #4ade80;
      font-weight: 600;
      background: rgba(74, 222, 128, 0.15);
    }
    
    .word-correct.animate-pop {
      animation: correctPop 0.3s ease-out;
    }
    
    .word-incorrect {
      font-weight: 600;
      background: rgba(248, 113, 113, 0.2);
      padding: 6px 10px;
      border: 1px solid rgba(248, 113, 113, 0.3);
    }
    
    .word-incorrect.animate-shake {
      animation: incorrectShake 0.3s ease-out;
    }
    
    .word-incorrect .correct-char {
      color: #ffffff;
      font-weight: 700;
    }
    
    .word-incorrect .wrong-char {
      color: #f87171;
      font-weight: 700;
      background: rgba(248, 113, 113, 0.3);
      padding: 0 2px;
      border-radius: 2px;
    }
    
    .word-incorrect .extra-char {
      color: #f87171;
      text-decoration: line-through;
      text-decoration-thickness: 2px;
      font-weight: 700;
    }
    
    .word-current {
      color: #ffffff;
      font-weight: 600;
      background: rgba(147, 51, 234, 0.2);
      border: 2px solid #9333ea;
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(147, 51, 234, 0.3);
    }
    
    .word-pending {
      color: #64748b;
      opacity: 0.7;
    }
    
    @keyframes correctPop {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }
    
    @keyframes incorrectShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }
    
    .char {
      display: inline-block;
    }
    
    .char-correct {
      color: #4ade80;
    }
    
    .char-incorrect {
      color: #f87171;
      background: rgba(248, 113, 113, 0.2);
      border-radius: 2px;
    }
    
    .cursor-blink {
      display: inline-block;
      width: 2px;
      height: 1.2em;
      background: #9333ea;
      margin-left: 2px;
      animation: blink 1s infinite;
      vertical-align: text-bottom;
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .word-row {
      text-align: justify;
      text-justify: inter-word;
      font-size: 1.5rem;
      line-height: 2.5rem;
      min-height: 56px;
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      gap: 0;
    }

    .word-row::after {
      content: "";
      flex: auto;
    }

    #words-display {
      scrollbar-width: none;
      -ms-overflow-style: none;
      overflow: hidden;
      position: relative;
    }
    
    #words-display::-webkit-scrollbar {
      display: none;
    }

    #words-container {
      transition: transform 0.3s ease-out;
      will-change: transform;
    }
  </style>
</head>
<body class="bg-slate-950 text-white">
  <!-- Animated Background Blobs -->
  <div class="fixed inset-0 pointer-events-none overflow-hidden">
    <div class="blob w-96 h-96 bg-purple-500 top-0 -left-48" style="animation-delay: 0s;"></div>
    <div class="blob w-96 h-96 bg-blue-500 bottom-0 -right-48" style="animation-delay: 2s;"></div>
    <div class="blob w-96 h-96 bg-indigo-500 top-1/2 left-1/2" style="animation-delay: 4s;"></div>
  </div>

  <div class="relative">
    <!-- Navigation -->
    <nav class="sticky top-0 z-50 bg-slate-950/95 border-b border-white/5 backdrop-blur-sm">
      <div class="container mx-auto px-6 py-4">
        <div class="flex justify-between items-center">
          <a href="/" class="flex items-center gap-3 hover:opacity-80 transition">
            <div class="w-10 h-10 rounded-xl flex items-center justify-center">
              <img src="/icon/meteoricon.png" alt="Typemeteor" class="w-10 h-10">
            </div>
            <h1 class="text-2xl font-black gradient-text">TYPEMETEOR</h1>
          </a>
          <a href="/" class="text-gray-300 hover:text-white transition flex items-center gap-2">
            <span>Back to Home</span>
          </a>
        </div>
      </div>
    </nav>

    <div class="container mx-auto px-6 py-8 max-w-5xl">
      <!-- Language Info -->
      <div class="text-center mb-8">
        <div id="language-flag" class="mb-3">
          <img src="/flag/indonesia.png" alt="Language Flag" class="w-24 h-24 mx-auto object-contain">
        </div>
        <h2 id="language-name" class="text-4xl font-black mb-2">
          <span class="gradient-text">Indonesian</span> Typing Test
        </h2>
        <p class="text-xl text-gray-400">1 minute test - Type as many words as you can!</p>
      </div>

      <!-- Stats Bar -->
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6 text-center transition-all hover:border-slate-600">
          <div class="mb-2">
            <img src="/icon/clock.png" alt="Clock" class="w-12 h-12 mx-auto">
          </div>
          <div id="timer" class="text-4xl font-black gradient-text">60</div>
          <div class="text-sm text-gray-400 font-medium mt-1">Time Left</div>
        </div>
        
        <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6 text-center transition-all hover:border-slate-600">
          <div class="mb-2">
            <img src="/icon/wpm.png" alt="WPM" class="w-12 h-12 mx-auto">
          </div>
          <div id="wpm" class="text-4xl font-black text-green-400 transition-all">0</div>
          <div class="text-sm text-gray-400 font-medium mt-1">WPM</div>
        </div>
        
        <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6 text-center transition-all hover:border-slate-600">
          <div class="mb-2">
            <img src="/icon/accuracy.png" alt="Accuracy" class="w-12 h-12 mx-auto">
          </div>
          <div id="accuracy" class="text-4xl font-black text-yellow-400 transition-all">100%</div>
          <div class="text-sm text-gray-400 font-medium mt-1">Accuracy</div>
        </div>
      </div>

      <!-- Test Area -->
      <div id="test-area" class="bg-slate-800 border border-slate-700 rounded-3xl p-8">
        <!-- Words Display Area -->
        <div id="words-display" class="mb-6 p-8 bg-slate-900/50 rounded-2xl h-48 leading-relaxed select-none overflow-hidden relative">
          <div id="words-container" class="text-2xl"></div>
        </div>
        
        <!-- Input Area -->
        <input
          id="typing-input"
          type="text"
          placeholder="Start typing here..."
          class="w-full p-5 text-xl bg-slate-900 border-2 border-purple-500 rounded-xl focus:outline-none focus:border-purple-400 focus:ring-2 focus:ring-purple-500/20 transition-all text-white placeholder-gray-500"
          autocomplete="off"
          autofocus
        />
        
        <div id="instruction" class="mt-4 text-center text-gray-400 text-lg transition-all">
          Start typing to begin the timer ‚è±Ô∏è
        </div>
        
        <button id="reset-btn" class="mt-6 mx-auto flex items-center gap-2 px-8 py-4 gradient-bg text-white font-bold rounded-xl hover:shadow-xl hover:shadow-purple-500/30 hover:scale-105 transition-all duration-300">
          <img src="/icon/restart.png" alt="Restart" class="w-5 h-5">
          <span>Restart Test</span>
        </button>
      </div>

      <!-- Results Screen -->
      <div id="results-screen" class="hidden bg-slate-800 border border-slate-700 rounded-3xl p-10 text-center mt-8 animate-fade-in">
        <div class="mb-6">
          <img src="/icon/meteorpurple.png" alt="Success" class="w-24 h-24 mx-auto">
        </div>
        <h2 class="text-4xl font-black mb-8">
          <span class="gradient-text">Your Results</span>
        </h2>
        
        <div class="grid grid-cols-2 gap-6 mb-10 max-w-2xl mx-auto">
          <div class="p-6 bg-purple-500/10 border border-purple-500/20 rounded-2xl hover:scale-105 transition-transform">
            <div id="final-wpm" class="text-5xl font-black gradient-text mb-2">0</div>
            <div class="text-gray-300 font-medium">Words Per Minute</div>
          </div>
          
          <div class="p-6 bg-green-500/10 border border-green-500/20 rounded-2xl hover:scale-105 transition-transform">
            <div id="final-accuracy" class="text-5xl font-black text-green-400 mb-2">0%</div>
            <div class="text-gray-300 font-medium">Accuracy</div>
          </div>
          
          <div class="p-6 bg-yellow-500/10 border border-yellow-500/20 rounded-2xl hover:scale-105 transition-transform">
            <div id="final-correct" class="text-5xl font-black text-yellow-400 mb-2">0</div>
            <div class="text-gray-300 font-medium">Correct Words</div>
          </div>
          
          <div class="p-6 bg-red-500/10 border border-red-500/20 rounded-2xl hover:scale-105 transition-transform">
            <div id="final-incorrect" class="text-5xl font-black text-red-400 mb-2">0</div>
            <div class="text-gray-300 font-medium">Wrong Words</div>
          </div>
        </div>

        <!-- Save Score -->
        <div class="mb-8 max-w-md mx-auto">
          <input
            id="player-name"
            type="text"
            placeholder="Enter your name"
            class="w-full p-4 mb-4 bg-white/10 border-2 border-purple-500/50 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 text-white placeholder-gray-400 text-lg transition-all"
          />
          <button id="save-score-btn" class="w-full px-6 py-4 bg-green-600 text-white font-bold text-lg rounded-xl hover:bg-green-700 hover:shadow-xl hover:shadow-green-500/30 hover:scale-105 transition-all duration-300">
            Save Score to Leaderboard
          </button>
        </div>

        <div class="flex gap-4 justify-center">
          <button id="try-again-btn" class="px-10 py-4 gradient-bg text-white text-lg font-bold rounded-xl hover:shadow-xl hover:shadow-purple-500/30 hover:scale-105 transition-all duration-300">
            Try Again
          </button>
          <a href="/" class="px-10 py-4 bg-white/10 border border-white/20 text-white text-lg font-bold rounded-xl hover:bg-white/20 hover:scale-105 transition-all duration-300">
            Back to Home
          </a>
        </div>
      </div>

      <!-- Leaderboard -->
      <div class="mt-10 bg-slate-800 border border-slate-700 rounded-3xl p-8">
        <h3 class="text-3xl font-black mb-6 text-center flex items-center justify-center gap-3">
          <img src="/icon/leaderboard.png" alt="Leaderboard" class="w-10 h-10">
          <span>Leaderboard - <span id="leaderboard-lang" class="gradient-text">Indonesian</span></span>
        </h3>
        <div id="leaderboard" class="space-y-3"></div>
      </div>
    </div>
  </div>

  <script>
    // Environment configuration
    const ENV = {
      API_URL: window.ENV?.API_URL || 'https://typemeteor.kikomik.workers.dev/api'
    };

    const languageConfig = {
      indonesian: { flag: '/flag/indonesia.png', name: 'Indonesian', display: 'Bahasa Indonesia' },
      english: { flag: '/flag/english.png', name: 'English', display: 'English' },
      spanish: { flag: '/flag/espanol.png', name: 'Spanish', display: 'Espa√±ol' },
      french: { flag: '/flag/francais.png', name: 'French', display: 'Fran√ßais' },
      german: { flag: '/flag/deutsch.png', name: 'German', display: 'Deutsch' },
      portuguese: { flag: '/flag/portugues.png', name: 'Portuguese', display: 'Portugu√™s' },
      japanese: { flag: '/flag/japan.png', name: 'Japanese', display: 'Êó•Êú¨Ë™û' }
    };

    class TypingTest {
      constructor() {
        this.allWords = [];
        this.words = [];
        this.currentWordIndex = 0;
        this.correctWords = 0;
        this.incorrectWords = 0;
        this.timeLeft = 60;
        this.isActive = false;
        this.isFinished = false;
        this.timer = null;
        this.typedWords = [];
        this.currentInput = '';
        this.rows = [];
        this.currentVisibleRow = 0;
        
        const path = window.location.pathname;
        const match = path.match(/\/language\/(\w+)/);
        this.language = match ? match[1] : 'indonesian';
        
        this.init();
      }

      init() {
        this.bindElements();
        this.updateLanguageDisplay();
        this.attachEventListeners();
        this.loadWords();
        this.loadLeaderboard();
      }

      bindElements() {
        this.elements = {
          languageFlag: document.getElementById('language-flag'),
          languageName: document.getElementById('language-name'),
          wordsDisplay: document.getElementById('words-display'),
          wordsContainer: document.getElementById('words-container'),
          typingInput: document.getElementById('typing-input'),
          timerEl: document.getElementById('timer'),
          wpmEl: document.getElementById('wpm'),
          accuracyEl: document.getElementById('accuracy'),
          instructionEl: document.getElementById('instruction'),
          resetBtn: document.getElementById('reset-btn'),
          testArea: document.getElementById('test-area'),
          resultsScreen: document.getElementById('results-screen'),
          finalWpm: document.getElementById('final-wpm'),
          finalAccuracy: document.getElementById('final-accuracy'),
          finalCorrect: document.getElementById('final-correct'),
          finalIncorrect: document.getElementById('final-incorrect'),
          tryAgainBtn: document.getElementById('try-again-btn'),
          playerName: document.getElementById('player-name'),
          saveScoreBtn: document.getElementById('save-score-btn'),
          leaderboard: document.getElementById('leaderboard'),
          leaderboardLang: document.getElementById('leaderboard-lang')
        };
      }

      updateLanguageDisplay() {
        const config = languageConfig[this.language] || languageConfig.indonesian;
        if (this.elements.languageFlag) {
          this.elements.languageFlag.innerHTML = `<img src="${config.flag}" alt="${config.name} Flag" class="w-24 h-24 mx-auto object-contain">`;
          this.elements.languageName.textContent = config.name;
          this.elements.leaderboardLang.textContent = config.name;
        }
      }

      attachEventListeners() {
        this.elements.typingInput.addEventListener('input', (e) => this.handleInput(e));
        this.elements.typingInput.addEventListener('keydown', (e) => this.handleKeyDown(e));
        this.elements.resetBtn.addEventListener('click', () => this.reset());
        this.elements.tryAgainBtn.addEventListener('click', () => this.reset());
        this.elements.saveScoreBtn.addEventListener('click', () => this.saveScore());
      }

      async loadWords() {
        try {
          const response = await fetch(`${ENV.API_URL}/words/${this.language}?count=500`);
          const data = await response.json();
          
          if (data.words && data.words.length > 0) {
            this.allWords = data.words;
            this.generateWords();
            console.log('‚úÖ Words loaded:', this.allWords.length);
          } else {
            throw new Error('No words received from API');
          }
        } catch (error) {
          console.error('Error loading words:', error);
          this.allWords = ['the', 'be', 'to', 'of', 'and', 'a', 'in', 'that', 'have', 'it', 'for', 'not', 'on', 'with', 'he', 'as', 'you', 'do', 'at', 'this', 'but', 'his', 'by', 'from', 'they', 'we', 'say', 'her', 'she', 'or'];
          this.generateWords();
          console.log('‚ö†Ô∏è  Using fallback words');
        }
      }

      generateWords() {
        this.words = [];
        for (let i = 0; i < 500; i++) {
          const randomIndex = Math.floor(Math.random() * this.allWords.length);
          this.words.push(this.allWords[randomIndex]);
        }
        this.calculateRows();
        this.displayWords();
      }
      
      calculateRows() {
        // Calculate rows dynamically based on container width
        const containerWidth = this.elements.wordsDisplay.offsetWidth - 64; // minus padding
        const avgCharWidth = 14; // approximate character width in pixels
        const wordSpacing = 6; // margin between words
        
        this.rows = [];
        let currentRow = [];
        let currentWidth = 0;
        
        for (let i = 0; i < this.words.length; i++) {
          const word = this.words[i];
          const wordWidth = (word.length * avgCharWidth) + 32 + wordSpacing; // word + padding + spacing
          
          if (currentWidth + wordWidth > containerWidth && currentRow.length > 0) {
            // Start new row
            this.rows.push([...currentRow]);
            currentRow = [i];
            currentWidth = wordWidth;
          } else {
            currentRow.push(i);
            currentWidth += wordWidth;
          }
        }
        
        // Add last row
        if (currentRow.length > 0) {
          this.rows.push(currentRow);
        }
      }

      displayWords() {
        // Always show 3 rows centered
        const startRow = this.currentVisibleRow;
        const endRow = Math.min(startRow + 3, this.rows.length);
        
        let rowsHTML = [];
        
        for (let rowIdx = startRow; rowIdx < endRow; rowIdx++) {
          const wordIndices = this.rows[rowIdx];
          let rowWordsHTML = [];
          
          for (const wordIndex of wordIndices) {
            const word = this.words[wordIndex];
            const typedWord = this.typedWords[wordIndex];
            
            let wordHtml = '';
            
            if (wordIndex === this.currentWordIndex) {
              wordHtml = `<span class="word word-current" data-index="${wordIndex}">`;
              wordHtml += this.renderCurrentWordChars(word);
              wordHtml += '</span>';
            } else if (typedWord !== undefined) {
              if (typedWord.isCorrect) {
                const animateClass = wordIndex === this.currentWordIndex - 1 && typedWord.justCompleted ? ' animate-pop' : '';
                wordHtml = `<span class="word word-correct${animateClass}" data-index="${wordIndex}">${word}</span>`;
              } else {
                const animateClass = wordIndex === this.currentWordIndex - 1 && typedWord.justCompleted ? ' animate-shake' : '';
                wordHtml = `<span class="word word-incorrect${animateClass}" data-index="${wordIndex}">`;
                wordHtml += this.renderIncorrectWord(word, typedWord.original);
                wordHtml += '</span>';
              }
            } else {
              wordHtml = `<span class="word word-pending" data-index="${wordIndex}">${word}</span>`;
            }
            
            rowWordsHTML.push(wordHtml);
          }
          
          rowsHTML.push(`<div class="word-row mb-3" data-row="${rowIdx}">${rowWordsHTML.join('')}</div>`);
        }
        
        this.elements.wordsContainer.innerHTML = rowsHTML.join('');
        
        // Always keep position at 0 - middle row is always centered
        this.elements.wordsContainer.style.transform = 'translateY(0)';
      }

      renderIncorrectWord(correctWord, typedWord) {
        let html = '';
        
        for (let i = 0; i < correctWord.length; i++) {
          const correctChar = correctWord[i];
          const typedChar = typedWord[i] || '';
          
          if (typedChar === correctChar) {
            html += `<span class="correct-char">${typedChar}</span>`;
          } else if (typedChar) {
            html += `<span class="wrong-char">${typedChar}</span>`;
          } else {
            html += `<span class="correct-char" style="opacity: 0.4">${correctChar}</span>`;
          }
        }
        
        if (typedWord.length > correctWord.length) {
          const extraChars = typedWord.slice(correctWord.length);
          html += `<span class="extra-char">${extraChars}</span>`;
        }
        
        return html;
      }

      renderCurrentWordChars(word) {
        const input = this.currentInput;
        let html = '';
        
        for (let i = 0; i < Math.max(word.length, input.length); i++) {
          const char = word[i] || '';
          const typedChar = input[i] || '';
          
          if (i >= word.length) {
            html += `<span class="char char-incorrect">${typedChar}</span>`;
          } else if (i >= input.length) {
            if (i === input.length) {
              html += `<span class="char">${char}<span class="cursor-blink"></span></span>`;
            } else {
              html += `<span class="char">${char}</span>`;
            }
          } else if (typedChar === char) {
            html += `<span class="char char-correct">${char}</span>`;
          } else {
            html += `<span class="char char-incorrect">${typedChar}</span>`;
          }
        }
        
        return html;
      }

      handleKeyDown(e) {
        const correctWord = this.words[this.currentWordIndex];
        const currentInput = this.currentInput;
        
        if (e.key === ' ') {
          if (currentInput.length === 0) {
            e.preventDefault();
            return;
          }
          
          if (currentInput.length < correctWord.length) {
            e.preventDefault();
            return;
          }
        }
      }

      handleInput(e) {
        const value = e.target.value;
        
        if (!this.isActive && value.length > 0) {
          this.startTest();
        }

        if (value.endsWith(' ')) {
          const typedWord = value.trim();
          const correctWord = this.words[this.currentWordIndex];
          
          const isCorrect = typedWord === correctWord;
          this.typedWords[this.currentWordIndex] = {
            original: typedWord,
            isCorrect: isCorrect,
            justCompleted: true
          };
          
          if (isCorrect) {
            this.correctWords++;
          } else {
            this.incorrectWords++;
          }
          
          // Find which row the current word is in
          let currentRowIndex = 0;
          for (let i = 0; i < this.rows.length; i++) {
            if (this.rows[i].includes(this.currentWordIndex)) {
              currentRowIndex = i;
              break;
            }
          }
          
          this.currentWordIndex++;
          
          // Check if moved to next row
          let newRowIndex = 0;
          for (let i = 0; i < this.rows.length; i++) {
            if (this.rows[i].includes(this.currentWordIndex)) {
              newRowIndex = i;
              break;
            }
          }
          
          // If moved to next row, scroll
          if (newRowIndex > currentRowIndex && newRowIndex > this.currentVisibleRow) {
            this.currentVisibleRow = newRowIndex;
          }
          
          this.currentInput = '';
          this.elements.typingInput.value = '';
          
          // Generate more words if needed
          if (this.currentWordIndex >= this.words.length - 50) {
            for (let i = 0; i < 100; i++) {
              const randomIndex = Math.floor(Math.random() * this.allWords.length);
              this.words.push(this.allWords[randomIndex]);
            }
            this.calculateRows(); // Recalculate rows with new words
          }
          
          this.displayWords();
          
          setTimeout(() => {
            if (this.typedWords[this.currentWordIndex - 1]) {
              this.typedWords[this.currentWordIndex - 1].justCompleted = false;
              this.displayWords();
            }
          }, 300);
          
          this.updateStats();
        } else {
          this.currentInput = value;
          this.displayWords();
        }
      }

      startTest() {
        this.isActive = true;
        this.elements.instructionEl.textContent = 'Keep typing! Press SPACE after each word üöÄ';
        
        this.timer = setInterval(() => {
          this.timeLeft--;
          this.elements.timerEl.textContent = this.timeLeft;
          
          if (this.timeLeft <= 0) {
            this.finishTest();
          }
        }, 1000);
      }

      updateStats() {
        const wpm = this.calculateWPM();
        const accuracy = this.calculateAccuracy();
        
        this.elements.wpmEl.textContent = wpm;
        this.elements.accuracyEl.textContent = `${accuracy}%`;
      }

      calculateWPM() {
        const timeElapsed = 60 - this.timeLeft;
        if (timeElapsed === 0) return 0;
        return Math.round((this.correctWords / timeElapsed) * 60);
      }

      calculateAccuracy() {
        const total = this.correctWords + this.incorrectWords;
        if (total === 0) return 100;
        return Math.round((this.correctWords / total) * 100);
      }

      finishTest() {
        clearInterval(this.timer);
        this.isActive = false;
        this.isFinished = true;
        this.elements.typingInput.disabled = true;
        
        this.showResults();
      }

      showResults() {
        this.elements.resultsScreen.classList.remove('hidden');
        
        this.elements.finalWpm.textContent = this.calculateWPM();
        this.elements.finalAccuracy.textContent = `${this.calculateAccuracy()}%`;
        this.elements.finalCorrect.textContent = this.correctWords;
        this.elements.finalIncorrect.textContent = this.incorrectWords;
        
        setTimeout(() => {
          this.elements.resultsScreen.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      }

      async saveScore() {
        const name = this.elements.playerName.value.trim();
        if (!name) {
          alert('Please enter your name!');
          return;
        }

        const scoreData = {
          name,
          wpm: this.calculateWPM(),
          accuracy: this.calculateAccuracy(),
          language: this.language,
          correctWords: this.correctWords,
          incorrectWords: this.incorrectWords
        };

        try {
          await fetch(`${ENV.API_URL}/scores`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(scoreData)
          });
          
          alert('Score saved successfully! üéâ');
          this.loadLeaderboard();
        } catch (error) {
          console.error('Error saving score:', error);
          alert('Failed to save score');
        }
      }

      async loadLeaderboard() {
        try {
          const response = await fetch(`${ENV.API_URL}/leaderboard?language=${this.language}&limit=10`);
          const data = await response.json();
          
          this.elements.leaderboard.innerHTML = data.leaderboard && data.leaderboard.length > 0
            ? data.leaderboard.map((score, i) => `
                <div class="flex items-center justify-between p-5 bg-slate-900/50 rounded-2xl hover:bg-slate-900/70 hover:scale-[1.02] transition-all duration-300 border border-slate-700">
                  <div class="flex items-center gap-4">
                    <span class="text-3xl min-w-[3rem]">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i + 1}.`}</span>
                    <span class="font-bold text-lg">${score.name}</span>
                  </div>
                  <div class="flex gap-6 items-center">
                    <div class="text-right">
                      <div class="text-2xl font-black gradient-text">${score.wpm}</div>
                      <div class="text-xs text-gray-400 font-medium">WPM</div>
                    </div>
                    <div class="text-right">
                      <div class="text-xl font-bold text-green-400">${score.accuracy}%</div>
                      <div class="text-xs text-gray-400 font-medium">Accuracy</div>
                    </div>
                  </div>
                </div>
              `).join('')
            : '<p class="text-center text-gray-400 py-8">No scores yet. Be the first! üöÄ</p>';
        } catch (error) {
          console.error('Error loading leaderboard:', error);
          this.elements.leaderboard.innerHTML = '<p class="text-center text-gray-400 py-8">Failed to load leaderboard</p>';
        }
      }

      reset() {
        clearInterval(this.timer);
        this.currentWordIndex = 0;
        this.correctWords = 0;
        this.incorrectWords = 0;
        this.timeLeft = 60;
        this.isActive = false;
        this.isFinished = false;
        this.typedWords = [];
        this.currentInput = '';
        this.currentVisibleRow = 0;
        this.rows = [];
        
        this.elements.typingInput.value = '';
        this.elements.typingInput.disabled = false;
        this.elements.timerEl.textContent = '60';
        this.elements.wpmEl.textContent = '0';
        this.elements.accuracyEl.textContent = '100%';
        this.elements.instructionEl.textContent = 'Start typing to begin the timer ‚è±Ô∏è';
        this.elements.playerName.value = '';
        
        this.elements.resultsScreen.classList.add('hidden');
        this.elements.wordsContainer.style.transform = 'translateY(0)';
        
        this.generateWords();
        this.elements.typingInput.focus();
      }
    }

    new TypingTest();
  </script>
</body>
</html>